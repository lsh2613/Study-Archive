# 컨텍스트 스위칭
> - 기존에 실행되던 스레드를 중단하고 다른 스레드를 실행하는 것.
> - 이전 스레드를 다시 실행하기 위해 스레드를 중단하는 시점에 CPU에서 상용하던 상태들을 메모리에 저장해둔다.
> - 이러한 저장 과정때문에 멀티스레드는 항상 효율적이진 않다.

# CPU와 스레드

- CPU - 4개, 스레드 2개
    - 스레드의 숫자가 너무 적으면 모든 CPU를 100% 다 활용할 수 없지만, 스레드가 몇 개 없으므로 컨텍스트 스위칭 비용 이 줄어든다.

- CPU - 4개, 스레드 100개
    - 스레드의 숫자가 너무 많으면 CPU를 100% 다 활용할 수 있지만 컨텍스트 스위칭 비용이 늘어난다.

- CPU - 4개, 스레드 4개
    - 스레드의 숫자를 CPU의 숫자에 맞춘다면 CPU를 100% 활용할 수 있고, 컨텍스트 스위칭 비용도 자주 발생하지 않기 때문에 최적의 상태가 된다. **이상적으로는 CPU 코어 수 + 1개 정도로 스레드를 맞추면 특정 스레드가 잠시 대기할 때 남은 스레드를 활용할 수 있다.**

# 스레드가 하는 작업
- CPU-바운드 작업 (CPU-bound tasks)
    - CPU의 연산 능력을 많이 요구하는 작업을 의미
    - 이러한 작업은 주로 계산, 데이터 처리, 알고리즘 실행 등 CPU의 처리 속도가 작업 완료 시간을 결정하는 경우
- I/O-바운드 작업 (I/O-bound tasks)
    - 디스크, 네트워크, 파일 시스템 등과 같은 입출력(I/O) 작업을 많이 요구하는 작업을 의미
    - 이러한 작업은 I/O 작업이 완료될 때까지 대기 시간이 많이 발생하며, CPU는 상대적으로 유휴(대기) 상태 에 있는 경우가 많다. 쉽게 이야기해서 스레드가 CPU를 사용하지 않고 I/O 작업이 완료될 때까지 대기
    - 예시: 데이터베이스 쿼리 처리, 파일 읽기/쓰기, 네트워크 통신, 사용자 입력 처리 등.

# CPU-스레드 갯수 정하기
- 웹 애플리케이션 서버
    - 분야마다 다르겠지만, 실무에서는 CPU-바운드 작업 보다는 I/O-바운드 작업이 많다.
    - 예를 들어서 백엔드 개발자의 경우 주로 웹 애플리케이션 서버를 개발하는데, 스레드가 계산, 연산과 같은 cpu 작업 보다는, 대부분 사용자의 입력을 기다리거나, 데이터베이스를 호출하고 그 결과를 기다리는 등, 기다 리는 일이 많다. 쉽게 이야기해서 스레드가 CPU를 많이 사용하지 않는 I/O-바운드 작업이 많다는 뜻이다.
    - 사용자의 요청을 하나 처리하는데, 스레드는 CPU를 1%정도 사용한다고 가정해보자. 이떄 CPU 코어가 4개와 이 갯수에 맞춰 스레드를 4개로 설정하게 되면, 4개의 요청을 동시에 처리할 수 있지만 CPU는 결국 4%만 사용하게 되어 CPU가 놀고있는 사태가 벌어진다.
        - 이러한 이론을 모르고 단순히 성능이 2배 좋은 장비를 구매하게 되면 오히려 CPU는 4%의 절반인 2%만 사용하고 사용자는 여전히 동시에 4명밖에 받지 못한다.
        - 단순히 생각해도 CPU를 100% 활용하기 위해선 스레드를 100개 생성할 수 있다.
    
## 결론    
> 스레드의 숫자는 CPU-바운드 작업이 많은가, 아니면 I/O-바운드 작업이 많은가에 따라 다르게 설정해야 한 다.

- CPU-바운드 작업
    - CPU 코어 수 + 1개 
    - CPU를 거의 100% 사용하는 작업이므로 스레드를 CPU 숫자에 최적화
- I/O-바운드 작업
    - CPU 코어 수 보다 많은 스레드를 생성, CPU를 최대한 사용할 수 있는 숫자까지 스레드 생성 CPU를 많이 사용하지 않으므로 성능 테스트를 통해 CPU를 최대한 활용하는 숫자까지 스레드 생성
    - 단 너무 많은 스레드를 생성하면 컨텍스트 스위칭 비용도 함께 증가 - 적절한 성능 테스트 필요
    
참고로 웹 애플리케이션 서버라도 상황에 따라 CPU 바운드 작업이 많을 수 있다. 이 경우 CPU-바운드 작업에 최적화 된 CPU 숫자를 고려하면 된다.